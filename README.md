# Репозиторий Ansible

Состав репозитория:

## Файлы

- **ansible.cfg** - конфигурационный файл ansible;
- **ansible.key** - приватный ключ для доступа к ВМ по SSH. Чтобы не хранить ключ в открытом виде, он зашифрован при помощи утилиты `ansible vault`. Расшифровка происходит первым шагом при запуске плейбука. Для расшифровки требуется пароль, который в данном случае вводится через аргумент командной строки `--ask-vault-pass=` при запуске плейбука;
- **config.yml** - файл с переменными, который подгружается при исполнении плейбука. В нем можно указать версии используемых сервисов, которые требуется установить, можно установить флаг для пропуска установки (например, если нужно только обновить конфигурацию уже установленного сервиса). Некоторые параметры конфигурации тоже выведены в этот файл;
- **inventory.yml** - файл с перечнем хостов, которые логически сгруппированы. В качестве адреса хоста используется DNS-запись, что позволяет не править IP-адреса при каждом редеплое инфраструктуры. Здесь же путем группировки можно изменить перечень хостов, на который устанавливается тот или иной сервис (например, если добавить хост в группу docker, на него установится docker);
- **playbook.yml** - основной плейбук, который первым шагом расшифровывает приватный ключ, а затем по очереди запускает деплой сервисов, используя соответствующие роли.

## Роли

1. **webservers** - установка `Nginx` и статики, обновление статики;
1. **metrics** - установка и конфигурация экспортеров (`NodeExporter`, `NgninxlogExporter`);
1. **grafana** - установка и конфигурация `Grafana`;
1. **prometheus** - установка и конфигурация `Prometheus`;
1. **docker** - установка docker на виртуальные машины для `ElasticSearch` и `Kibana`;
1. **elasticsearch** - установка и конфигурация `Elasticsearch`;
1. **kibana** - установка и конфигурация `Kibana`;
1. **fluent-bit**/filebeat* - установка сборщика логов;

> *По умолчанию в качестве beat выбран `fluent-bit`, так как `filebeat` не доступен для свободной загрузки, а запускать его в контейнере и прокидывать туда логи nginx кажется не самым оптимальным решением, плюс есть сложности с правами. Однако, возможность установки `docker` и `filebeat` есть, нужно лишь отредактировать inventory-файл, добавив в группу `docker-servers` хосты с `nginx`, и раскоментировать соответствующую таску в плейбуке.
